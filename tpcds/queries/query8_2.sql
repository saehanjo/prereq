select * from (select  s_store_name
       ,sum(ss_net_profit)
  from store_sales
      ,date_dim
      ,store,
      (select ca_zip
      from (
       SELECT substr(ca_zip,1,5) ca_zip
       FROM customer_address
       WHERE substr(ca_zip,1,5) IN (
                           '90639','14172','85225','72515','32487','21772',
                           '63651','79160','18220','51567','10897',
                           '33633','99472','34548','62006','57130',
                           '18535','33974','63839','78312','64189',
                           '29512','67643','64860','28778','79140',
                           '65026','60774','73491','12853','68742',
                           '16316','78359','79708','32307','48813',
                           '15889','81337','10920','56249','25729',
                           '45556','31807','40528','62371','53452',
                           '60239','51956','50862','43249','94817',
                           '53793','12973','76950','97963','18577',
                           '48162','44420','30635','44480','20292',
                           '56504','26499','14584','85758','33027',
                           '54212','10854','14744','71653','59028',
                           '82923','17559','29146','32247','37952',
                           '26091','88264','89486','14211','45318',
                           '38877','48495','60800','89795','37743',
                           '21657','82275','82963','82035','44795',
                           '10942','45809','69572','58317','26363',
                           '83537','74417','62118','46285','69392',
                           '42290','24784','40155','18679','23189',
                           '71254','62791','79274','33029','99061',
                           '94654','61925','92238','19257','34165',
                           '54267','81535','24398','35194','59425',
                           '73696','31614','16847','96016','10427',
                           '16115','29586','37313','56228','17712',
                           '94671','61316','77500','38550','48191',
                           '80639','26909','52882','56584','57008',
                           '21695','26994','87230','51473','81627',
                           '41331','20477','64542','32441','55689',
                           '91086','91069','97403','87142','16603',
                           '47477','52581','69181','43101','23340',
                           '14982','82176','33616','87857','46898',
                           '37432','84848','14771','16515','75400',
                           '99617','91194','76724','33794','97824',
                           '12658','58668','27069','70007','64008',
                           '69359','38033','24282','65240','12247',
                           '57146','98180','21187','37389','86420',
                           '27268','34678','56641','69615','51651',
                           '12685','85021','86776','39381','26876',
                           '21876','21251','21024','50090','48509',
                           '25738','28171','68794','96102','11219',
                           '32195','58956','64098','36561','52895',
                           '49772','47511','37253','40169','73912',
                           '20076','61892','17714','72388','45094',
                           '51968','35594','17005','48597','36217',
                           '63800','45675','43544','18489','66183',
                           '78450','79559','13096','10039','69383',
                           '55072','91928','50431','59904','94487',
                           '70361','20279','77554','24632','28750',
                           '62372','43091','29839','50163','12871',
                           '48513','69482','37515','16288','31664',
                           '51458','12535','57481','34024','97236',
                           '50330','75009','29867','23162','24131',
                           '67667','15399','26528','17556','33460',
                           '60967','47699','39215','71547','87566',
                           '94348','29122','16460','31172','13573',
                           '30202','67254','17242','30741','70571',
                           '22598','37854','21939','13850','10709',
                           '25502','13943','12886','11926','13423',
                           '27904','40599','88090','81708','43117',
                           '46320','62037','30897','13267','56711',
                           '64913','87177','85667','75872','44696',
                           '12500','68717','49196','44509','23595',
                           '79831','86781','87314','28468','18726',
                           '63913','50568','48830','49539','40076',
                           '50071','79715','12766','38933','17576',
                           '17760','23485','71389','44828','65171',
                           '53812','56750','74569','41048','88785',
                           '60188','36312','34590','81603','39621',
                           '60791','27340','25300','71618','17206',
                           '39792','75380','13272','13802','27861',
                           '52804','33318','72941','60524','91349',
                           '99634','51040','72791','14602','80407',
                           '68571','40287','91420','82250','29429',
                           '87995','28254','33519','27561','93250',
                           '73665','32772','75086','72209','47462',
                           '71923','98974','91759','88320','32999',
                           '43103','85447','84693','60026','49349',
                           '63368','97970','96374','84461')
      intersect
       select ca_zip
       from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
             FROM customer_address, customer
             WHERE ca_address_sk = c_current_addr_sk and
                   c_preferred_cust_flag='Y'
             group by ca_zip
             having count(*) > 10)A1)A2) V1
  where ss_store_sk = s_store_sk
   and ss_sold_date_sk = d_date_sk
   and d_qoy = 1 and d_year = 2001
   and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
  group by s_store_name
  order by s_store_name
   ) where rownum <= 100;