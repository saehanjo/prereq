select * from (select  s_store_name
       ,sum(ss_net_profit)
  from store_sales
      ,date_dim
      ,store,
      (select ca_zip
      from (
       SELECT substr(ca_zip,1,5) ca_zip
       FROM customer_address
       WHERE substr(ca_zip,1,5) IN (
                           '51592','12874','75448','20526','16598','69481',
                           '44178','63847','77089','75738','84435',
                           '98644','39816','33520','34022','15943',
                           '67802','45641','99472','56662','87449',
                           '42444','43694','75902','50118','75017',
                           '50715','62809','15236','17085','94980',
                           '12088','65425','97710','12356','69804',
                           '63833','77425','51500','40726','37375',
                           '40322','29603','88705','17263','72523',
                           '34073','27932','40144','30361','33672',
                           '36224','24800','11264','63956','53289',
                           '64793','31524','55196','19896','23609',
                           '12538','94831','65052','10283','86888',
                           '13855','72258','26896','30930','23919',
                           '21060','65601','20669','36498','74869',
                           '32954','65913','87405','26321','43950',
                           '53315','20530','80857','48162','24635',
                           '27485','13695','74428','62238','72907',
                           '39680','70066','18682','11400','83568',
                           '65232','75610','13253','73607','38168',
                           '16611','41237','18090','80672','59028',
                           '39876','38403','66620','99144','53591',
                           '13019','51376','39927','32449','20922',
                           '45960','78655','86886','93439','37194',
                           '57367','14176','82050','13032','70976',
                           '90428','67352','75724','86921','62851',
                           '92006','89081','70270','44513','67286',
                           '25958','80363','92023','37849','42953',
                           '26055','18647','12479','34843','74218',
                           '95563','14999','49989','51854','70059',
                           '93432','31297','85679','88102','41891',
                           '61619','32194','20987','26496','55478',
                           '48576','31195','50292','98005','66485',
                           '12210','74095','17156','79340','37362',
                           '77285','78358','35825','29243','93559',
                           '25429','42169','25813','46415','40564',
                           '63969','36572','31162','14592','79161',
                           '83895','66213','39868','35109','22047',
                           '18612','72747','25265','49037','33829',
                           '56337','21118','58143','94131','89977',
                           '30990','34173','74712','28668','30333',
                           '23874','91008','67661','25327','64480',
                           '20003','17255','41455','25414','39295',
                           '67223','71757','56401','41331','73833',
                           '10580','71943','28374','96485','36919',
                           '31769','19243','20507','72735','23822',
                           '26101','26058','63533','92915','29364',
                           '82698','32575','87592','16355','17443',
                           '55246','61341','80330','73109','16028',
                           '10541','70082','67157','22163','34781',
                           '40355','77987','17976','51321','88954',
                           '22769','60514','11792','12628','45819',
                           '93004','48825','84063','33623','21524',
                           '80705','17513','47850','84245','97990',
                           '14488','63098','17334','23865','27264',
                           '47741','71342','53822','20335','92320',
                           '31399','49729','92697','62526','36597',
                           '77452','22616','58169','86111','10856',
                           '31755','68859','43862','90087','37656',
                           '57856','49535','24001','38054','15134',
                           '29760','54549','54697','93565','62106',
                           '71774','21181','12640','20573','34945',
                           '94686','39775','44564','51829','99290',
                           '53849','14428','19954','90672','20438',
                           '34600','31145','39147','20767','16219',
                           '29889','67200','26421','16354','76440',
                           '18029','30925','79693','43158','36716',
                           '72388','87556','82525','68778','32342',
                           '25115','19399','65118','28307','26188',
                           '48616','84234','31608','19678','31806',
                           '86186','37243','36126','78450','57951',
                           '52076','43931','63084','12012','57571',
                           '64324','51024','30829','13100','26220',
                           '76467','13543','93149','53664','87184',
                           '38868','39789','32198','14464','67363',
                           '47310','85812','85101','14161','27639',
                           '50163','50055','86119','59980','17165',
                           '31020','13492','87638','85656','47165',
                           '15448','31348','69895','48255','19976',
                           '83661','11909','79681','63380')
      intersect
       select ca_zip
       from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
             FROM customer_address, customer
             WHERE ca_address_sk = c_current_addr_sk and
                   c_preferred_cust_flag='Y'
             group by ca_zip
             having count(*) > 10)A1)A2) V1
  where ss_store_sk = s_store_sk
   and ss_sold_date_sk = d_date_sk
   and d_qoy = 1 and d_year = 1999
   and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
  group by s_store_name
  order by s_store_name
   ) where rownum <= 100;