select * from (select  s_store_name
       ,sum(ss_net_profit)
  from store_sales
      ,date_dim
      ,store,
      (select ca_zip
      from (
       SELECT substr(ca_zip,1,5) ca_zip
       FROM customer_address
       WHERE substr(ca_zip,1,5) IN (
                           '90639','94164','47590','53566','35383','33543',
                           '17929','57300','26439','73814','63819',
                           '35530','93617','17968','90660','69888',
                           '27069','11745','83327','25570','79739',
                           '13794','95370','75237','99472','58279',
                           '36404','64748','12561','29646','17405',
                           '53769','81782','39064','60966','16833',
                           '28130','69026','28444','26628','87844',
                           '47015','16689','68420','71371','89687',
                           '55238','10976','13766','90262','89633',
                           '47249','89733','53899','12278','80894',
                           '41112','88556','39446','75929','44043',
                           '96760','71157','67052','50678','52517',
                           '79708','95128','19487','47241','48813',
                           '11299','86252','98753','60846','15888',
                           '90235','97766','85324','10904','20408',
                           '53104','26879','69645','85942','52764',
                           '12359','64549','10139','87164','87952',
                           '55245','93771','49413','46653','71687',
                           '86978','17247','44089','15699','81597',
                           '93211','53793','20812','60747','71055',
                           '35540','54122','96579','23316','87923',
                           '49819','48162','11994','44420','58446',
                           '94257','72160','32484','46482','80065',
                           '62914','56504','67960','26499','28732',
                           '22229','55524','40039','82561','44373',
                           '22387','66688','77817','15901','86381',
                           '87925','32596','64601','14803','59028',
                           '28327','47427','72120','60697','69606',
                           '97081','11188','42875','46524','11377',
                           '21748','88490','42068','34065','55276',
                           '84953','14073','44714','39945','94597',
                           '33337','36142','52791','50638','37669',
                           '71216','40263','19541','94732','18600',
                           '98846','88740','48425','33769','95647',
                           '33437','78657','18225','67524','43319',
                           '45070','45668','81461','41887','14332',
                           '20644','59828','52138','16152','20106',
                           '20677','68120','34854','40553','52089',
                           '23198','84734','52422','62044','70059',
                           '26021','30030','71477','65846','38334',
                           '97369','83775','37026','92203','50031',
                           '32225','24264','59925','67458','46017',
                           '47133','28321','68216','25629','11509',
                           '10154','54498','35279','56199','13774',
                           '89084','26809','65154','65764','62433',
                           '75247','77068','81377','90553','38816',
                           '49367','16202','16213','68437','55631',
                           '69473','31116','64969','37400','49110',
                           '16847','55657','83599','95832','30866',
                           '76949','82534','44598','39302','23154',
                           '67886','38963','48742','21351','60112',
                           '28554','63912','97905','54577','67934',
                           '27776','35872','92584','79870','44614',
                           '80219','25524','51896','50517','88658',
                           '52063','61789','39288','61177','41035',
                           '69927','44826','45836','73974','95853',
                           '87230','27812','42172','29071','47494',
                           '86807','41331','81327','73937','17765',
                           '36352','44672','15771','79429','21593',
                           '10822','61044','38336','65655','75239',
                           '97403','28351','77755','83005','47495',
                           '96831','80706','98710','67683','54691',
                           '65570','40534','21154','36394','71184',
                           '24789','72890','80186','82176','22527',
                           '30891','91135','40883','76354','88764',
                           '96494','24219','12747','43163','16818',
                           '68147','72476','31195','36328','73711',
                           '18089','37987','10060','94409','70022',
                           '14454','78780','58739','22119','77480',
                           '21581','54144','12564','13540','47488',
                           '77541','83235','70007','25337','94342',
                           '38658','29588','89224','30116','47232',
                           '38122','95801','26203','46836','71160',
                           '49968','67140','37971','44073','25394',
                           '30458','46507','54523','83233','72223',
                           '53682','41727','62293','58169','44219',
                           '33791','97947','75434','62685','56234',
                           '38725','33469','60187','37017','30876',
                           '20332','16775','39381','78301')
      intersect
       select ca_zip
       from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
             FROM customer_address, customer
             WHERE ca_address_sk = c_current_addr_sk and
                   c_preferred_cust_flag='Y'
             group by ca_zip
             having count(*) > 10)A1)A2) V1
  where ss_store_sk = s_store_sk
   and ss_sold_date_sk = d_date_sk
   and d_qoy = 2 and d_year = 1999
   and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
  group by s_store_name
  order by s_store_name
   ) where rownum <= 100;